#!/command/with-contenv sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Check for passphrase.
#======================================================================================================================

[[ -z "${BACKUP_DUPLICITY_PASSPHRASE-}" ]] \
    && bf-error "You must define BACKUP_DUPLICITY_PASSPHRASE." "run"


#======================================================================================================================
# Verify rclone configuration.
#======================================================================================================================

[[ -f ${RCLONE_CONFIG} ]] \
    || bf-error "rclone configuration not found." "run"

[[ ${BF_LIB}/test-rclone-storage ]] \
    || bf-error "rclone storage '${BACKUP_RCLONE_STORAGE}' is not defined." "run"


#======================================================================================================================
# Execute backup.
#======================================================================================================================

PASSPHRASE=${BACKUP_DUPLICITY_PASSPHRASE} \
    duplicity --full-if-older-than ${BACKUP_DUPLICITY_FULL_EVERY} \
    "${BACKUP_SOURCE}" "rclone://${BACKUP_RCLONE_STORAGE}:${BACKUP_RCLONE_PATH}"
