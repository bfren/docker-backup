#!/command/with-contenv sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Test setup.
#======================================================================================================================

${BF_LIB}/test-setup
${BF_LIB}/backup-starting


#======================================================================================================================
# If this is not a cron task, add the progress flag.
#======================================================================================================================

if [ ! "${CRON-}" = "1" ] ; then
    ADDITIONAL_ARGS="--progress"
fi


#======================================================================================================================
# Run cleanup in case a previous session failed.
#======================================================================================================================

dup-cleanup


#======================================================================================================================
# Execute default backup.
#======================================================================================================================

bf-echo "Executing backup..."
duplicity \
    --allow-source-mismatch \
    --archive-dir ${BACKUP_DUPLICITY_ARCHIVE} \
    --exclude-filelist ${BACKUP_DUPLICITY_EXCLUSIONS} \
    --full-if-older-than ${BACKUP_DUPLICITY_FULL_EVERY} \
    --log-file ${BACKUP_DUPLICITY_LOG} \
    --verbosity ${BACKUP_DUPLICITY_VERBOSITY} \
    --volsize ${BACKUP_DUPLICITY_VOLSIZE_IN_MB} \
    ${ADDITIONAL_ARGS-} \
    "${BACKUP_SOURCE}" "rclone://${BACKUP_RCLONE_STORAGE}:${BACKUP_RCLONE_PATH}" \
    || true
bf-done


#======================================================================================================================
# Remove old backup files.
#======================================================================================================================

dup-remove-old


#======================================================================================================================
# Backup complete.
#======================================================================================================================

${BF_LIB}/backup-done
