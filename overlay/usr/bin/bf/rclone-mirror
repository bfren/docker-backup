#!/command/with-contenv sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Test setup.
#======================================================================================================================

${BF_LIB}/test-setup


#======================================================================================================================
# Run rclone sync with options to create a mirror.
# (Config file location is read from environment variables by rclone.)
#======================================================================================================================

bf-echo "Executing rclone mirror..."
rclone sync \
    --checksum \                            # Skip based on checksum (if available) & size, not mod-time & size
    --delete-during \                       # When synchronizing, delete files on destination before transferring
    --delete-excluded \                     # Delete files on dest excluded from sync
    --exclude-from=${RCLONE_EXCLUSIONS} \   # Read file exclude patterns from file
    --log-file=${RCLONE_LOG} \              # Log everything to this file
    --progress \                            # Show progress during transfer
    "${BACKUP_SOURCE}" \
    "${BACKUP_RCLONE_STORAGE}:${BACKUP_RCLONE_PATH}"
bf-done

rclone size \
    "${BACKUP_RCLONE_STORAGE}:${BACKUP_RCLONE_PATH}"
