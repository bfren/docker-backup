#!/command/with-contenv sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Test setup.
#======================================================================================================================

${BF_LIB}/test-setup
${BF_LIB}/log-starting


#======================================================================================================================
# Get whether or not this is executing as a cron.
#======================================================================================================================

if [ "${CRON-}" -ne "1" ] ; then
    ADDITIONAL_ARGS="--progress"
fi


#======================================================================================================================
# Execute full backup.
#======================================================================================================================

bf-echo "Executing full backup..."
duplicity full \
    --allow-source-mismatch \
    --archive-dir ${DUPLICITY_ARCHIVE} \
    --exclude-filelist ${DUPLICITY_EXCLUSIONS} \
    --volsize ${BACKUP_DUPLICITY_VOLSIZE_IN_MB} \
    ${ADDITIONAL_ARGS-} \
    "${BACKUP_SOURCE}" "rclone://${BACKUP_RCLONE_STORAGE}:${BACKUP_RCLONE_PATH}"
bf-done

${BF_LIB}/log-done
